{% extends 'base.html' %}
{% block title %}Gestión de Pedidos{% endblock %}

{% block content %}
<div class="container mt-4">

    <!-- Título -->
    <div class="row mb-4">
        <div class="col">
            <h2><i class="bi bi-receipt-cutoff"></i> Gestión de Pedidos</h2>
        </div>
    </div>

    <!-- Filtros -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="GET" action="{% url 'pedidos:lista_pedidos' %}">
                <div class="row g-3 align-items-center">

                    <!-- Botón Nuevo Pedido -->
                    <div class="col-md-3 col-sm-6">
                        <a href="{% url 'pedidos:crear_pedido' %}" class="btn btn-primary w-100">
                            <i class="bi bi-plus-circle-fill"></i> Nuevo Pedido
                        </a>
                    </div>

                    <!-- Buscar -->
                    <div class="col-md-3 col-sm-6">
                        <input 
                            type="text" 
                            name="buscar" 
                            class="form-control"
                            placeholder="Buscar por cliente o ID..." 
                            value="{{ buscar }}"
                        >
                    </div>

                    <!-- Filtro por fecha -->
                    <div class="col-md-3 col-sm-6">
                        <div class="input-group">
                            <span class="input-group-text bg-light">
                                <i class="bi bi-calendar-event"></i>
                            </span>
                            <input 
                                type="date" 
                                name="fecha" 
                                class="form-control"
                                value="{{ fecha }}"
                            >
                            <button type="submit" class="btn btn-outline-secondary">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Filtro por estado -->
                    <div class="col-md-3 col-sm-6">
                        <select name="estado" class="form-select" onchange="this.form.submit()">
                            <option value="">Todos</option>
                            <option value="ABIERTO" {% if estado == 'ABIERTO' %}selected{% endif %}>Abierto</option>
                            <option value="PAGADO" {% if estado == 'PAGADO' %}selected{% endif %}>Pagado</option>
                            <option value="CANCELADO" {% if estado == 'CANCELADO' %}selected{% endif %}>Cancelado</option>
                        </select>
                    </div>

                </div>
            </form>
        </div>
    </div>


    <!-- Lista de Pedidos -->
    <div class="row">

        {% for pedido in pedidos %}
        <div class="col-md-4 mb-4">
            <div class="card h-100 shadow-sm">

                <!-- Cuerpo -->
                <div class="card-body">

                    <h5 class="card-title">
                        Pedido #{{ pedido.id }}
                    </h5>

                    <p class="mb-1"><strong>Cliente:</strong> 
                        {{ pedido.cliente|default:"Sin cliente" }}
                    </p>

                    <p class="mb-1"><strong>Total:</strong> ${{ pedido.total }}</p>

                    <p class="mb-1"><strong>Fecha:</strong> 
                        {{ pedido.fecha_pedido|date:"Y-m-d H:i" }}
                    </p>

                    <!-- Estado con badge -->
                    <p>
                        <strong>Estado:</strong>
                        {% if pedido.estado == 'ABIERTO' %}
                            <span class="badge bg-warning text-dark">Abierto</span>
                        {% elif pedido.estado == 'PAGADO' %}
                            <span class="badge bg-success">Pagado</span>
                        {% else %}
                            <span class="badge bg-secondary">Cancelado</span>
                        {% endif %}
                    </p>
                </div>

                <!-- Footer con acciones -->
                <div class="card-footer text-center">
                    <div class="btn-group" role="group">

                        <!-- Editar pedido -->
                        <a href="{% url 'pedidos:editar_pedido' pedido.id %}" 
                           class="btn btn-sm btn-warning" title="Editar">
                            <i class="bi bi-pencil-fill"></i>
                        </a>

                        <!-- Cancelar pedido -->
                        {% if pedido.estado != 'CANCELADO' %}
                        <a href="{% url 'pedidos:cambiar_estado_pedido' pedido.id 'CANCELADO' %}" 
                           class="btn btn-sm btn-danger"
                           title="Cancelar"
                           onclick="return confirm('¿Cancelar esta orden?');">
                            <i class="bi bi-x-circle-fill"></i>
                        </a>
                        {% endif %}

                        <!-- Marcar como pagado -->
                        {% if pedido.estado == 'ABIERTO' %}
                        <a href="{% url 'pedidos:cambiar_estado_pedido' pedido.id 'PAGADO' %}" 
                           class="btn btn-sm btn-success"
                           title="Pagar"
                           onclick="return confirm('¿Marcar como pagado?');">
                            <i class="bi bi-cash"></i>
                        </a>
                        {% endif %}

                    </div>
                </div>

            </div>
        </div>

        {% empty %}
        <p class="text-center text-muted">No hay pedidos registrados.</p>
        {% endfor %}
    </div>

</div>
{% endblock %}
