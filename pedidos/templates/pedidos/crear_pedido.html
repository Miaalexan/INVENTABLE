{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">Crear Pedido</h2>

    <!-- Formulario principal -->
    <form method="POST" id="pedidoForm">
        {% csrf_token %}

        <!-- DATOS DEL PEDIDO -->
        <div class="card mb-4">
            <div class="card-header bg-dark text-white">
                Datos del Pedido
            </div>
            <div class="card-body row g-3">
                <div class="col-md-4">
                    <label class="form-label">Cliente</label>
                    {{ pedido_form.cliente }}
                </div>
                <div class="col-md-4">
                    <label class="form-label">Reserva</label>
                    {{ pedido_form.reserva }}
                </div>
                <div class="col-md-4">
                    <label class="form-label">Estado</label>
                    {{ pedido_form.estado }}
                </div>
            </div>
        </div>

        <!--  SECCIÓN DE CATEGORÍAS Y PRODUCTOS -->
        <div class="row">
            <!-- CATEGORÍAS -->
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-header bg-secondary text-white">
                        Categorías
                    </div>
                    <div class="card-body">
                        {% for categoria in categorias %}
                            <div class="mb-2">
                                <button class="btn btn-outline-primary w-100 mb-2" 
                                        type="button"
                                        data-bs-toggle="collapse"
                                        data-bs-target="#categoria{{ categoria.id }}">
                                    {{ categoria.nombre }}
                                </button>

                                <div class="collapse" id="categoria{{ categoria.id }}">
                                    <div class="list-group">
                                        {% for producto in categoria.productos.all %}
                                            <button type="button" 
                                                    class="list-group-item list-group-item-action producto-btn"
                                                    data-id="{{ producto.id }}"
                                                    data-nombre="{{ producto.nombre }}"
                                                    data-precio="{{ producto.precio }}">
                                                {{ producto.nombre }} - ${{ producto.precio }}
                                            </button>
                                        {% empty %}
                                            <div class="text-muted small">Sin productos</div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        {% empty %}
                            <p class="text-muted">No hay categorías registradas.</p>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- DETALLES DEL PEDIDO -->
            <div class="col-md-8">
                <div class="card h-100">
                    <div class="card-header bg-secondary text-white">
                        Detalles del Pedido
                    </div>
                    <div class="card-body">
                        <table class="table table-bordered align-middle" id="tabla-detalles">
                            <thead class="table-light">
                                <tr>
                                    <th>Producto</th>
                                    <th>Cantidad</th>
                                    <th>Precio Unitario</th>
                                    <th>Subtotal</th>
                                    <th>Acción</th>
                                </tr>
                            </thead>
                            <tbody id="detalle-body">
                                <!-- Filas dinámicas -->
                            </tbody>
                        </table>

                        <div class="d-flex justify-content-between mt-3">
                            <h5>Total: $<span id="total">0.00</span></h5>
                            <div class="d-flex gap-2">

    <!-- Botón Guardar -->
    <button type="submit" name="accion" value="guardar" class="btn btn-secondary">
        Guardar
    </button>

    <!-- Selección de método de pago -->
    <select name="metodo_pago" class="form-select w-auto">
        <option value="efectivo">Efectivo</option>
        <option value="tarjeta">Tarjeta</option>
    </select>

    <!-- Botón pagar -->
    <button type="submit" name="accion" value="pagar" class="btn btn-success">
        Pagar
    </button>

</div>

                        </div>
                    </div>
                </div>
            </div>
        </div>

    </form>
</div>

<!--  SCRIPT PARA AGREGAR PRODUCTOS  -->
<script>
document.addEventListener("DOMContentLoaded", function() {
    const detalleBody = document.getElementById("detalle-body");
    const totalSpan = document.getElementById("total");
    let total = 0;

    document.querySelectorAll(".producto-btn").forEach(btn => {
        btn.addEventListener("click", () => {
            const id = btn.dataset.id;
            const nombre = btn.dataset.nombre;
            const precio = parseFloat(btn.dataset.precio);

            // Verificar si el producto ya está en la tabla
            let existente = document.querySelector(`#fila-${id}`);
            if (existente) {
                let cantidadInput = existente.querySelector(".cantidad");
                cantidadInput.value = parseInt(cantidadInput.value) + 1;
                cantidadInput.dispatchEvent(new Event("change"));
                return;
            }

            const fila = document.createElement("tr");
            fila.id = `fila-${id}`;
            fila.innerHTML = `
                <td>${nombre}</td>
                <td><input type="number" class="form-control cantidad" value="1" min="1"></td>
                <td class="precio">${precio.toFixed(2)}</td>
                <td class="subtotal">${precio.toFixed(2)}</td>
                <td><button type="button" class="btn btn-danger btn-sm eliminar">BORRAR</button></td>
            `;
            detalleBody.appendChild(fila);

            actualizarTotal();

            fila.querySelector(".cantidad").addEventListener("change", actualizarTotal);
            fila.querySelector(".eliminar").addEventListener("click", () => {
                fila.remove();
                actualizarTotal();
            });
        });
    });

    function actualizarTotal() {
        total = 0;
        document.querySelectorAll("#detalle-body tr").forEach(fila => {
            const cantidad = parseInt(fila.querySelector(".cantidad").value);
            const precio = parseFloat(fila.querySelector(".precio").textContent);
            const subtotal = cantidad * precio;
            fila.querySelector(".subtotal").textContent = subtotal.toFixed(2);
            total += subtotal;
        });
        totalSpan.textContent = total.toFixed(2);
    }
});
</script>
{% endblock %}
