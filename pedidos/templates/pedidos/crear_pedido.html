{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">
        {% if modo_edicion %}Editar Pedido #{{ pedido_form.instance.id }}{% else %}Crear Pedido{% endif %}
    </h2>

    <form method="POST" id="pedidoForm">
        {% csrf_token %}

        <!-- DATOS DEL PEDIDO -->
        <div class="card mb-4">
            <div class="card-header bg-dark text-white">
                Datos del Pedido
            </div>

            <div class="card-body row g-3">
                <div class="col-md-4">
                    <label class="form-label">Cliente</label>
                    {{ pedido_form.cliente }}
                </div>

                <div class="col-md-4">
                    <label class="form-label">Reserva</label>
                    {{ pedido_form.reserva }}
                </div>

                <div class="col-md-4">
                    <label class="form-label">Estado</label>
                    {{ pedido_form.estado }}
                </div>
            </div>
        </div>

        <!-- SECCIÓN DE CATEGORÍAS Y PRODUCTOS -->
        <div class="row">

            <!-- CATEGORÍAS -->
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-header bg-secondary text-white">
                        Categorías
                    </div>
                    <div class="card-body">
                        {% for categoria in categorias %}
                            <div class="mb-2">
                                <button class="btn btn-outline-primary w-100 mb-2" 
                                        type="button"
                                        data-bs-toggle="collapse"
                                        data-bs-target="#categoria{{ categoria.id }}">
                                    {{ categoria.nombre }}
                                </button>

                                <div class="collapse" id="categoria{{ categoria.id }}">
                                    <div class="list-group">
                                        {% for producto in categoria.productos.all %}
                                            <button type="button" 
                                                    class="list-group-item list-group-item-action producto-btn"
                                                    data-id="{{ producto.id }}"
                                                    data-nombre="{{ producto.nombre }}"
                                                    data-precio="{{ producto.precio }}">
                                                {{ producto.nombre }} - ${{ producto.precio }}
                                            </button>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- DETALLES DEL PEDIDO -->
            <div class="col-md-8">
                <div class="card h-100">
                    <div class="card-header bg-secondary text-white">
                        Detalles del Pedido
                    </div>

                    <div class="card-body">
                        <table class="table table-bordered align-middle" id="tabla-detalles">
                            <thead class="table-light">
                                <tr>
                                    <th>Producto</th>
                                    <th>Cantidad</th>
                                    <th>Precio Unitario</th>
                                    <th>Subtotal</th>
                                    <th>Acción</th>
                                </tr>
                            </thead>

                            <tbody id="detalle-body">
                                <!-- Se llenará dinámicamente -->
                            </tbody>
                        </table>

                        <div class="d-flex justify-content-between mt-3">
                            <h5>Total: $<span id="total">0.00</span></h5>

                            <div class="d-flex gap-2">
                                <!-- Botón Guardar -->
                                <button type="submit" name="accion" value="guardar" class="btn btn-secondary">
                                    Guardar
                                </button>

                                <!-- Método de pago -->
                                <select name="metodo_pago" class="form-select w-auto">
                                    <option value="efectivo">Efectivo</option>
                                    <option value="tarjeta">Tarjeta</option>
                                    <option value="transferencia">Transferencia</option>
                                </select>

                                <!-- Botón pagar -->
                                <button type="submit" name="accion" value="pagar" class="btn btn-success">
                                    Pagar
                                </button>
                            </div>

                        </div>
                    </div>

                </div>
            </div>
        </div>

    </form>
</div>

<!-- SCRIPT PARA AGREGAR PRODUCTOS Y CARGAR DETALLES EXISTENTES -->
<script>
document.addEventListener("DOMContentLoaded", function() {
    const detalleBody = document.getElementById("detalle-body");
    const totalSpan = document.getElementById("total");

    // Función para agregar fila a la tabla
    function agregarFila(id, nombre, precio, cantidad) {
        const fila = document.createElement("tr");
        fila.id = `fila-${id}`;

        const subtotal = precio * cantidad;

        fila.innerHTML = `
            <td>
                ${nombre}
                <input type="hidden" name="producto_id[]" value="${id}">
            </td>

            <td>
                <input type="number" class="form-control cantidad" value="${cantidad}" min="1">
                <input type="hidden" name="cantidad[]" class="cantidad-hidden" value="${cantidad}">
            </td>

            <td>
                <span class="precio">${precio.toFixed(2)}</span>
                <input type="hidden" name="precio[]" value="${precio}">
            </td>

            <td class="subtotal">${subtotal.toFixed(2)}</td>

            <td>
                <button type="button" class="btn btn-danger btn-sm eliminar">BORRAR</button>
            </td>
        `;

        detalleBody.appendChild(fila);

        fila.querySelector(".cantidad").addEventListener("change", actualizarTotal);
        fila.querySelector(".eliminar").addEventListener("click", () => {
            fila.remove();
            actualizarTotal();
        });
    }

    // Cargar detalles de un pedido existente (modo edición)
    {% if modo_edicion %}
        {% for d in detalles_existentes %}
            agregarFila({{ d.producto.id }}, "{{ d.producto.nombre }}", {{ d.precio_unitario }}, {{ d.cantidad }});
        {% endfor %}
        actualizarTotal();
    {% endif %}

    // Evento de agregar producto desde el menú
    document.querySelectorAll(".producto-btn").forEach(btn => {
        btn.addEventListener("click", () => {
            const id = btn.dataset.id;
            const nombre = btn.dataset.nombre;
            const precio = parseFloat(btn.dataset.precio);

            let existente = document.querySelector(`#fila-${id}`);
            if (existente) {
                let cantidad = existente.querySelector(".cantidad");
                cantidad.value = parseInt(cantidad.value) + 1;
                cantidad.dispatchEvent(new Event("change"));
                return;
            }

            agregarFila(id, nombre, precio, 1);
            actualizarTotal();
        });
    });

    // Recalcular total
    function actualizarTotal() {
        let total = 0;

        document.querySelectorAll("#detalle-body tr").forEach(fila => {
            const cantidadInput = fila.querySelector(".cantidad");
            const cantidadHidden = fila.querySelector(".cantidad-hidden");

            const cantidad = parseInt(cantidadInput.value);
            const precio = parseFloat(fila.querySelector(".precio").textContent);

            const subtotal = cantidad * precio;
            fila.querySelector(".subtotal").textContent = subtotal.toFixed(2);

            cantidadHidden.value = cantidad;

            total += subtotal;
        });

        totalSpan.textContent = total.toFixed(2);
    }
});
</script>

{% endblock %}
