{% extends "base.html" %}
{% load static %}

{% block title %}Dashboard - INVENTABLE{% endblock %}

{% block content %}
<div class="container mt-4">

    <h2 class="mb-3"><i class="bi bi-speedometer2"></i> Panel de Control</h2>

    <!-- ===== Filtro por fecha ===== -->
    <form method="GET" class="card p-3 shadow-sm mb-4">
        <div class="row g-3">
            <div class="col-md-4">
                <label class="form-label">Fecha inicio</label>
                <input type="date" name="fecha_inicio" class="form-control" value="{{ fecha_inicio }}">
            </div>
            <div class="col-md-4">
                <label class="form-label">Fecha fin</label>
                <input type="date" name="fecha_fin" class="form-control" value="{{ fecha_fin }}">
            </div>
            <div class="col-md-4 d-flex align-items-end">
                <button class="btn btn-primary w-100">
                    <i class="bi bi-search"></i> Aplicar filtro
                </button>
            </div>
        </div>
    </form>

    <!-- ===== Cards principales ===== -->
    <div class="row g-4">
        <div class="col-md-3">
            <div class="card text-center shadow-sm p-3">
                <small class="text-muted">Total Pedidos</small>
                <h3 class="mt-2">{{ total_pedidos }}</h3>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center shadow-sm p-3">
                <small class="text-muted">Pedidos Pagados</small>
                <h3 class="mt-2 text-success">{{ pedidos_pagados }}</h3>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center shadow-sm p-3">
                <small class="text-muted">Pedidos Abiertos</small>
                <h3 class="mt-2 text-warning">{{ pedidos_abiertos }}</h3>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center shadow-sm p-3">
                <small class="text-muted">Ventas Totales</small>
                <h3 class="mt-2 text-primary">${{ ventas_totales|floatformat:2 }}</h3>
            </div>
        </div>
    </div>

    <!-- ===== Ventas rango (si se aplica) y ventas mes/semana ===== -->
    <div class="row g-4 mt-3">
        <div class="col-md-4">
            <div class="card shadow-sm p-3">
                <small class="text-muted">Ventas (rango/aplicado)</small>
                <h4 class="mt-2">${{ ventas_rango|floatformat:2 }}</h4>
                <small class="text-muted">Si no aplica filtro, muestra ventas de pagados totales</small>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow-sm p-3">
                <small class="text-muted">Ventas (mes)</small>
                <h4 class="mt-2">${{ ventas_mes|floatformat:2 }}</h4>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow-sm p-3">
                <small class="text-muted">Ventas (semana)</small>
                <h4 class="mt-2">${{ ventas_semana|floatformat:2 }}</h4>
            </div>
        </div>
    </div>

    <!-- ===== Top 3 mas / menos vendidos ===== -->
    <div class="row g-4 mt-3">
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">Top 3 - Más vendidos</div>
                <div class="card-body">
                    {% if mas_vendidos %}
                        <ul class="list-group">
                            {% for p in mas_vendidos %}
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    {{ p.producto__nombre }}
                                    <span class="badge bg-success rounded-pill">{{ p.total_cant }}</span>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p class="text-muted">No hay datos en este rango.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header bg-danger text-white">Top 3 - Menos vendidos</div>
                <div class="card-body">
                    {% if menos_vendidos %}
                        <ul class="list-group">
                            {% for p in menos_vendidos %}
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    {{ p.producto__nombre }}
                                    <span class="badge bg-danger rounded-pill">{{ p.total_cant }}</span>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p class="text-muted">No hay datos en este rango.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- ===== Horas pico ===== -->
    <div class="row g-4 mt-3">
        <div class="col-md-6">
            <div class="card shadow-sm p-3">
                <small class="text-muted">Hora con más Reservas</small>
                {% if hora_mas_reservas %}
                    <h3 class="mt-2">{{ hora_mas_reservas.hora }}:00</h3>
                    <p class="text-muted">{{ hora_mas_reservas.total }} reservas</p>
                {% else %}
                    <p class="text-muted">No hay datos</p>
                {% endif %}
            </div>
        </div>

        <div class="col-md-6">
            <div class="card shadow-sm p-3">
                <small class="text-muted">Hora con más Pedidos</small>
                {% if hora_mas_pedidos %}
                    <h3 class="mt-2">{{ hora_mas_pedidos.hora }}:00</h3>
                    <p class="text-muted">{{ hora_mas_pedidos.total }} pedidos</p>
                {% else %}
                    <p class="text-muted">No hay datos</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- ===== Gráfica ventas últimos 7 días ===== -->
    <div class="card shadow-sm mt-4">
        <div class="card-body">
            <h5 class="mb-3">Ventas últimos 7 días</h5>
            <canvas id="chart7days" height="90"></canvas>
        </div>
    </div>

    <!-- ===== Últimos pedidos ===== -->
    <div class="card shadow-sm mt-4 mb-5">
        <div class="card-body">
            <h5 class="mb-3">Últimos pedidos</h5>
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead class="table-dark">
                        <tr>
                            <th>#</th><th>Cliente</th><th>Total</th><th>Estado</th><th>Fecha</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for p in ultimos_pedidos %}
                            <tr>
                                <td>{{ p.id }}</td>
                                <td>{{ p.cliente }}</td>
                                <td>${{ p.total|floatformat:2 }}</td>
                                <td>{{ p.estado }}</td>
                                <td>{{ p.fecha|date:"Y-m-d H:i" }}</td>
                            </tr>
                        {% empty %}
                            <tr><td colspan="5" class="text-center text-muted">No hay pedidos.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // parse ventas_7_days safely
    const ventas7 = JSON.parse('{{ ventas_7_days_json|escapejs }}');
    const labels = ventas7.map(v => v.date);
    const values = ventas7.map(v => v.value);

    const ctx = document.getElementById('chart7days').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Ventas ($)',
                data: values,
                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        },
        options: {
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
</script>

{% endblock %}
